<!DOCTYPE html><html>
<head>
  <title>Push-to-Talk Voice Chat</title>
  <style>
    body { font-family: Arial; text-align: center; background: #f0f2f5; }
    #storeSelect, #employeeList { margin: 10px; padding: 10px; font-size: 16px; }
    #pushToTalkBtn {
      background-color: #007bff;
      color: white;
      padding: 15px 30px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    #pushToTalkBtn:active {
      background-color: red;
    }
  </style>
</head>
<body>
  <h2>Store Voice Chat (Push-to-Talk)</h2>
  <select id="storeSelect">
    <option disabled selected>Select Store</option>
  </select>
  <div id="employeeList"></div>
  <br>
  <button id="pushToTalkBtn" disabled>Hold to Talk</button>  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDxEvM3IUpl6xzG4Y1om80Cwomo4xnbFQo",
      authDomain: "abc-trial-73e0a.firebaseapp.com",
      projectId: "abc-trial-73e0a",
      storageBucket: "abc-trial-73e0a.firebasestorage.app",
      messagingSenderId: "813805020246",
      appId: "1:813805020246:web:8c26aa4c5ea4b57fd847f7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const stores = {
      "Store A": ["Alice", "Bob", "Charlie"],
      "Store B": ["David", "Eve", "Frank"],
      "Store C": ["Grace", "Heidi", "Ivan"]
    };

    const storeSelect = document.getElementById("storeSelect");
    const employeeList = document.getElementById("employeeList");
    const talkButton = document.getElementById("pushToTalkBtn");

    let localStream;
    let peers = {};
    let currentStore = null;

    for (let store in stores) {
      let option = document.createElement("option");
      option.value = store;
      option.innerText = store;
      storeSelect.appendChild(option);
    }

    storeSelect.addEventListener("change", async () => {
      currentStore = storeSelect.value;
      employeeList.innerHTML = `<strong>Employees:</strong> ${stores[currentStore].join(", ")}`;
      talkButton.disabled = false;

      // Join room and listen
      await setupConnection(currentStore);
    });

    talkButton.addEventListener("mousedown", async () => {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      for (let peerId in peers) {
        localStream.getTracks().forEach(track => peers[peerId].addTrack(track, localStream));
      }
    });

    talkButton.addEventListener("mouseup", () => {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
    });

    async function setupConnection(roomName) {
      const userId = Math.random().toString(36).substring(2);
      const roomRef = db.ref("rooms/" + roomName);

      // Listen for others
      roomRef.on("child_added", async (snap) => {
        const remoteId = snap.key;
        if (remoteId === userId || peers[remoteId]) return;

        const peerConnection = new RTCPeerConnection();
        peers[remoteId] = peerConnection;

        peerConnection.ontrack = (event) => {
          const audio = document.createElement("audio");
          audio.srcObject = event.streams[0];
          audio.autoplay = true;
          document.body.appendChild(audio);
        };

        const offer = snap.val();
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        db.ref(`rooms/${roomName}/${userId}`).set(peerConnection.localDescription.toJSON());
      });

      // Send offer
      const pc = new RTCPeerConnection();
      peers[userId] = pc;

      pc.onicecandidate = (event) => {
        if (event.candidate) return;
        db.ref("rooms/" + roomName + "/" + userId).set(pc.localDescription.toJSON());
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
    }
  </script></body>
</html>
