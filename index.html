<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floor Control System</title>
    <style>
        :root { 
            --primary: #2b3a4a; 
            --secondary: #3f5f6f; 
            --accent: #4fb3bf; 
            --background: linear-gradient(135deg, #2b3a4a 0%, #3f5f6f 100%);
            font-family: "Segoe UI", sans-serif;
        }

        /* Dynamic Banner */
        .dynamic-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #4fb3bf, #2b3a4a, #3f5f6f);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            animation: bannerPulse 8s infinite;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        @keyframes bannerPulse {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .banner-close {
            margin-left: auto;
            cursor: pointer;
            padding: 5px;
        }

        /* Barcode Scanner Modal */
        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
        }
        .scanner-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .scanner-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2em;
            cursor: pointer;
        }
        .scanner-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        /* Shift Color Coding */
        .shift-AM { background: rgba(0, 123, 255, 0.3); }
        .shift-PM { background: rgba(40, 167, 69, 0.3); }
        .shift-MID { background: rgba(111, 66, 193, 0.3); }
        .shift-DAY-OFF { background: rgba(108, 117, 125, 0.3); }
        .shift-LEAVE { background: rgba(220, 53, 69, 0.3); }
        .shift-SICK { background: rgba(253, 126, 20, 0.3); }

        /* Core Styles */
        body { 
            font-family: "Segoe UI", sans-serif; 
            margin: 0; 
            padding: 60px 20px 20px; 
            background: var(--background); 
            color: white; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        .container { max-width: 1200px; margin: 0 auto; flex: 1; width: 100%; box-sizing: border-box; }
        .glass-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; margin: 20px 0; border: 1px solid rgba(255, 255, 255, 0.2); }
        .header-container { display: flex; justify-content: space-between; align-items: center; position: relative; flex-wrap: wrap; gap: 10px; }
        .dropdown-container { display: flex; flex-direction: column; gap: 10px; min-width: 250px; }
        .lock-icon { font-size: 1.5em; cursor: pointer; transition: transform 0.2s ease; }
        .lock-icon:hover { transform: scale(1.1); }
        .staff-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; padding-bottom: 20px; border-bottom: 2px solid rgba(255, 255, 255, 0.3); }
        .staff-badge { padding: 14px 24px; background: rgba(255, 255, 255, 0.15); border-radius: 24px; cursor: pointer; transition: all 0.3s ease; border: 3px solid rgba(255, 255, 255, 0.4); font-size: 1.2em; white-space: nowrap; }
        .staff-badge.selected { border: 4px solid #4fb3bf; background: rgba(79, 179, 191, 0.35); box-shadow: 0 0 15px rgba(79, 179, 191, 0.6); animation: pulse 1.5s infinite; }
        .staff-badge.on-floor { background: rgba(144, 238, 144, 0.2); border-color: #90EE90; }
        .staff-badge.on-break { background: rgba(255, 215, 0, 0.2); border-color: #FFD700; }
        .staff-badge.logged-out { background: rgba(128, 128, 128, 0.2); border-color: #808080; }
        .staff-badge.day-off-leave { background: rgba(255, 0, 0, 0.2); border-color: #FF0000; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(79, 179, 191, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(79, 179, 191, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 179, 191, 0); } }
        .countdown-timer { font-size: 0.8em; margin-left: 8px; color: rgba(255, 255, 255, 0.7); }
        .stats-panel { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 20px; }
        .stat-box { background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 10px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: transform 0.3s ease; }
        .stat-box.morning-login { background: rgba(144, 238, 144, 0.2); border-color: #90EE90; }
        .stat-box.afternoon-login { background: rgba(255, 215, 0, 0.2); border-color: #FFD700; }
        .stat-box.on-break { background: rgba(255, 165, 0, 0.2); border-color: #FFA500; }
        .stat-box.on-floor { background: rgba(144, 238, 144, 0.2); border-color: #90EE90; }
        .stat-box.logged-out { background: rgba(128, 128, 128, 0.2); border-color: #808080; }
        .stat-box.day-off { background: rgba(255, 0, 0, 0.2); border-color: #FF0000; }
        .stat-box:hover { transform: scale(1.05); }
        .stat-box div { padding: 6px; border-radius: 5px; background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); }
        .stat-number { font-size: 1.8em; font-weight: bold; margin: 8px 0; color: var(--accent); }
        .action-buttons { margin: 25px 0; }
        .action-group { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 15px; }
        .track-btn { padding: 10px 20px; border: none; border-radius: 15px; background: rgba(79, 179, 191, 0.3); color: white; cursor: pointer; transition: all 0.2s ease; font-size: 0.9em; border: 2px solid var(--accent); flex: 1; min-width: 100px; }
        .track-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(79, 179, 191, 0.3); }
        .analysis-container { margin-top: 15px; max-height: 400px; overflow-y: auto; }
        .day-panel { background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .day-panel h3 { margin: 0 0 10px 0; color: var(--accent); }
        .analysis-table-wrapper { overflow-x: scroll; overflow-y: auto; max-height: 300px; position: relative; -webkit-overflow-scrolling: touch; }
        .analysis-table { width: 100%; border-collapse: collapse; min-width: 800px; background: rgba(128, 128, 128, 0.2); backdrop-filter: blur(10px); border-radius: 10px; table-layout: fixed; }
        .analysis-table th { background: rgba(150, 150, 150, 0.3); position: sticky; top: 0; z-index: 10; padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); text-align: left; }
        .analysis-table td:first-child, .analysis-table th:first-child { position: sticky; left: 0; background: rgba(100, 100, 100, 0.3); z-index: 15; padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); text-align: left; }
        .analysis-table td { padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); text-align: left; }
        .month-selector { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        select { padding: 10px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--accent); color: white; font-size: 1em; flex: 1; }
        .shift-dropdown {
            position: absolute;
            background: rgba(43, 58, 74, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 20;
            padding: 10px 0;
            width: 120px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: scale(0.9) translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            visibility: hidden;
        }
        .shift-dropdown.show {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
        }
        .shift-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
            color: white;
            text-align: center;
            border-radius: 8px;
            margin: 5px;
            background: rgba(255, 255, 255, 0.05);
        }
        .shift-option:hover {
            background: rgba(79, 179, 191, 0.5);
            transform: translateX(5px);
        }
        .shift-cell {
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .shift-cell:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .shift-cell.active {
            background: rgba(79, 179, 191, 0.4);
        }
        .message { padding: 15px 25px; border-radius: 10px; position: fixed; top: -100px; left: 50%; transform: translateX(-50%); opacity: 0; transition: all 0.5s ease; z-index: 1000; }
        .message.success { background: rgba(144, 238, 144, 0.2); border: 1px solid rgba(144, 238, 144, 0.5); }
        .message.error { background: rgba(255, 99, 71, 0.2); border: 1px solid rgba(255, 99, 71, 0.5); }
        .message.info { background: rgba(79, 179, 191, 0.2); border: 1px solid rgba(79, 179, 191, 0.5); }
        .message.active { opacity: 1; top: 20px; animation: messagePop 4s ease forwards; }
        @keyframes messagePop { 0% { transform: translateX(-50%) scale(0.8); opacity: 0; } 10% { transform: translateX(-50%) scale(1.05); opacity: 1; } 15% { transform: translateX(-50%) scale(1); } 85% { transform: translateX(-50%) scale(1); opacity: 1; } 100% { transform: translateX(-50%) scale(0.8); opacity: 0; } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1001; }
        .modal-content { background: rgba(43, 58, 74, 0.9); backdrop-filter: blur(12px); padding: 25px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 1px solid rgba(255, 255, 255, 0.2); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.8em; color: var(--accent); }
        .modal-close { background: none; border: none; color: white; font-size: 1.8em; cursor: pointer; }
        .modal-form { display: flex; flex-direction: column; gap: 15px; }
        .modal-form input, .modal-form select { padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--accent); color: white; font-size: 1.2em; }
        .modal-form button { padding: 12px; border: none; border-radius: 8px; background: var(--accent); color: white; cursor: pointer; font-size: 1.2em; }
        #modalList div { font-size: 1.2em; margin-bottom: 10px; color: white; background: rgba(255, 255, 255, 0.1); padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.2); opacity: 0; animation: fadeInUp 0.3s ease forwards; animation-delay: calc(0.1s * var(--i)); }
        @keyframes fadeInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .roster-table-container { overflow-x: auto; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); border-radius: 15px; padding: 15px; position: relative; }
        .roster-table { width: max-content; border-collapse: collapse; color: white; }
        .roster-table th, .roster-table td { padding: 12px; border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; min-width: 100px; }
        .roster-table th { background: rgba(255, 255, 255, 0.15); position: sticky; top: 0; z-index: 1; }
        .roster-table td:first-child { position: sticky; left: 0; background: rgba(43, 58, 74, 0.9); z-index: 1; }
        .walkie-talkie { display: flex; align-items: center; justify-content: center; gap: 5px; padding: 10px 20px; background: linear-gradient(45deg, #4fb3bf, #2b3a4a); border: none; border-radius: 25px; color: white; font-size: 1em; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; width: 180px; height: 50px; position: relative; }
        .walkie-talkie.active { background: linear-gradient(45deg, #90EE90, #32CD32); }
        .transmission-indicator { position: absolute; top: -5px; right: -5px; width: 10px; height: 10px; background: #32CD32; border-radius: 50%; animation: transmitting 1s infinite; display: none; }
        .walkie-talkie.active .transmission-indicator { display: block; }
        @keyframes transmitting { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }
        .active-count { font-size: 0.8em; margin-left: 5px; color: rgba(255, 255, 255, 0.7); }
        footer { text-align: center; font-size: 0.6em; color: rgba(255, 255, 255, 0.7); padding: 10px 0; animation: fadeInOut 2s infinite; }
        @keyframes fadeInOut { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
        .feature-section { margin-top: 20px; }
        .feature-section input { padding: 10px; width: 100%; max-width: 300px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--accent); color: white; }
        .feature-section button { margin-top: 10px; padding: 10px 20px; background: var(--accent); border: none; border-radius: 8px; color: white; cursor: pointer; }
        .feature-table-wrapper { overflow-x: auto; max-width: 100%; margin-top: 15px; -webkit-overflow-scrolling: touch; }
        .feature-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .feature-table th { background: rgba(255, 255, 255, 0.15); padding: 10px; border: 1px solid rgba(255, 255, 255, 0.3); text-align: left; position: sticky; top: 0; z-index: 10; }
        .feature-table td { padding: 10px; border: 1px solid rgba(255, 255, 255, 0.2); text-align: left; }
        .feature-table tbody tr { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .barcode-icon { cursor: pointer; font-size: 1.5em; margin-left: 10px; }
        #barcodeModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1002; }
        #barcodeModal .modal-content { background: rgba(43, 58, 74, 0.9); backdrop-filter: blur(12px); padding: 25px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 1px solid rgba(255, 255, 255, 0.2); animation: slideIn 0.3s ease; }
        #barcode-video { width: 100%; height: auto; border-radius: 8px; }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Play Recent Button */
        .play-recent {
            background: rgba(79, 179, 191, 0.3);
            border: 2px solid var(--accent);
            padding: 8px 15px;
            border-radius: 15px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }
        .play-recent:hover {
            background: rgba(79, 179, 191, 0.5);
        }

        @media (max-width: 768px) { 
            .stats-panel { grid-template-columns: repeat(2, 1fr); } 
            .action-group { grid-template-columns: repeat(2, 1fr); gap: 10px; } 
            .track-btn { width: 100%; margin-bottom: 10px; } 
            .staff-badge { padding: 12px 20px; font-size: 1em; } 
            .header-container { flex-direction: column; align-items: flex-start; } 
            .dropdown-container { width: 100%; } 
            .walkie-talkie { width: 100%; max-width: 180px; margin: 10px auto; } 
            .month-selector { flex-direction: column; } 
            .month-selector select, .month-selector .track-btn { width: 100%; } 
            .shift-dropdown { width: 100px; } 
            .feature-table { min-width: 100%; } 
        }
    </style>
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
    <!-- Dynamic Banner -->
    <div class="dynamic-banner" id="dynamicBanner">
        üî• <span id="bannerMessage"></span>
        <span class="banner-close" onclick="this.parentElement.style.display='none'">√ó</span>
    </div>

    <!-- Barcode Scanner Modal -->
    <div class="scanner-modal" id="scannerModal">
        <div class="scanner-close" onclick="stopScanner()">√ó</div>
        <video class="scanner-video" id="scannerVideo"></video>
        <canvas class="scanner-canvas" id="scannerCanvas"></canvas>
    </div>

    <div class="container" id="main-container">
        <!-- Header -->
        <div class="glass-panel">
            <div class="header-container">
                <div>
                    <h1 id="store-title">Floor Control</h1>
                    <div id="current-date"></div>
                </div>
                <div class="dropdown-container">
                    <select id="area-select" onchange="updateStoreDropdown()">
                        <option value="Area 1">Area 1</option>
                        <option value="Area 2" selected>Area 2</option>
                        <option value="Area 3">Area 3</option>
                    </select>
                    <select id="store-select" onchange="loadStoreData()">
                        <option value="">Select Store</option>
                    </select>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button class="walkie-talkie" id="walkie-talkie-btn" 
                                onmousedown="startWalkieTalkie()" onmouseup="stopWalkieTalkie()"
                                ontouchstart="startWalkieTalkie()" ontouchend="stopWalkieTalkie()">
                            <span>Walkie-Talkie</span> üéôÔ∏è <span class="active-count" id="active-count">0</span>
                            <div class="transmission-indicator"></div>
                        </button>
                        <button class="play-recent" onclick="playRecentBroadcast()">‚ñ∂ Play Recent</button>
                    </div>
                </div>
                <span class="lock-icon" style="position: absolute; top: 0; right: 0;" onclick="showLockModal()">üîí</span>
            </div>
        </div>

        <div id="message-container" class="message"></div>

        <!-- Team Members Section -->
        <div class="glass-panel">
            <h2>Team Members <span id="staff-count" style="color: var(--accent)">(Total: 0)</span></h2>
            <div class="staff-container" id="staff-list"></div>
            <div class="action-buttons">
                <div class="action-group">
                    <button class="track-btn login" onclick="handleLogin()">Login</button>
                    <button class="track-btn logout" onclick="handleLogout()">Logout</button>
                    <button class="track-btn start-break" onclick="handleBreak('start')">Start Break</button>
                    <button class="track-btn end-break" onclick="handleBreak('end')">End Break</button>
                </div>
            </div>
            <hr style="border: 1px solid rgba(255, 255, 255, 0.3); margin: 20px 0;">
            <div class="stats-panel" id="stats-panel">
                <div class="stat-box morning-login" onclick="showStatDetails('Morning Login')">
                    <div>Morning Login</div><div class="stat-number" id="morning-count">0</div>
                </div>
                <div class="stat-box afternoon-login" onclick="showStatDetails('Afternoon Login')">
                    <div>Afternoon Login</div><div class="stat-number" id="afternoon-count">0</div>
                </div>
                <div class="stat-box on-break" onclick="showStatDetails('On Break')">
                    <div>On Break</div><div class="stat-number" id="break-count">0</div>
                </div>
                <div class="stat-box on-floor" onclick="showStatDetails('On Floor')">
                    <div>On Floor</div><div class="stat-number" id="floor-count">0</div>
                </div>
                <div class="stat-box logged-out" onclick="showStatDetails('Logged Out')">
                    <div>Logged Out</div><div class="stat-number" id="left-count">0</div>
                </div>
                <div class="stat-box day-off" onclick="showStatDetails('Day Off')">
                    <div>Day Off / On Leave</div><div class="stat-number" id="day-off-count">0</div>
                </div>
            </div>
            <hr style="border: 1px solid rgba(255, 255, 255, 0.3); margin: 20px 0;">
            <button class="track-btn" style="margin-top: 15px;" onclick="showRosterModal()">Manage Roster</button>
        </div>

        <!-- Bin Hash Lookup -->
        <div class="glass-panel">
            <h2>Bin Hash Lookup</h2>
            <div class="feature-section">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="bin-search" placeholder="Enter Item ID">
                    <button class="track-btn" onclick="startScanner('bin-search')">üì∑ Scan</button>
                </div>
                <button class="track-btn" onclick="searchBinHash()">Search</button>
                <div class="feature-table-wrapper">
                    <table class="feature-table">
                        <thead><tr><th>Item ID</th><th>Description</th><th>Bin ID</th><th>Location</th></tr></thead>
                        <tbody id="bin-result"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Single Odd Pair Finder -->
        <div class="glass-panel">
            <h2>Single Odd Pair Finder</h2>
            <div class="feature-section">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="odd-search" placeholder="Enter Item ID">
                    <button class="track-btn" onclick="startScanner('odd-search')">üì∑ Scan</button>
                </div>
                <button class="track-btn" onclick="searchOddPair()">Search</button>
                <div class="feature-table-wrapper">
                    <table class="feature-table">
                        <thead><tr><th>Item ID</th><th>Right Count</th><th>Left Count</th><th>Locations</th></tr></thead>
                        <tbody id="odd-result"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Attendance Analysis (Moved Down) -->
        <div class="glass-panel" style="order: 99;">
            <h2>Attendance Analysis</h2>
            <div class="month-selector">
                <select id="month-select" onchange="updateAnalysis()"></select>
                <select id="date-select" onchange="filterByDate()"></select>
                <button class="track-btn" onclick="refreshData()">Refresh Data</button>
            </div>
            <div class="analysis-container" id="analysis-container"></div>
        </div>
    </div>

    <footer>Designed and Developed by Shankar Neupane | Ver 1.2.0 | Time Management System</footer>

    <!-- Modals -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Details</h2>
                <button class="modal-close" onclick="closeModal()">‚Üê</button>
            </div>
            <div id="modalList"></div>
        </div>
    </div>
    
    <div class="modal" id="lockModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Unlock Areas</h2>
                <button class="modal-close" onclick="closeLockModal()">‚Üê</button>
            </div>
            <div class="modal-form">
                <input type="text" id="unlock-username" placeholder="Area (e.g., Area 1)">
                <input type="password" id="unlock-password" placeholder="Password">
                <button onclick="unlockAreas()">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Separate Roster Panel -->
    <div class="modal" id="rosterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Manage Roster</h2>
                <button class="modal-close" onclick="closeRosterModal()">‚Üê</button>
            </div>
            <div class="glass-panel" style="margin: 15px 0;">
                <div class="roster-table-container">
                    <table class="roster-table" id="roster-table">
                        <thead id="roster-table-header"></thead>
                        <tbody id="roster-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            GOOGLE_SHEETS: {
                API_KEY: "AIzaSyCr1MlzzYR2uP9nK4ERh1FsbYSGpB5MJYc",
                SHEET_ID: "1uwh8Jy4diTbVK-SO6LZMEiba3uCgbuZUM3XARVr_Dug",
                RANGE: "Sheet1!A:D"
            },
            FIREBASE: {
                apiKey: "AIzaSyCBKQmhnE3E3TmF7UcyuM7NwQyM0FYzL-A",
                authDomain: "breakwatertimemgt.firebaseapp.com",
                databaseURL: "https://breakwatertimemgt-default-rtdb.firebaseio.com/",
                projectId: "breakwatertimemgt",
                storageBucket: "breakwatertimemgt.appspot.com",
                messagingSenderId: "806149652458",
                appId: "1:806149652458:web:d97884f60d2ff4644b7c93"
            },
            WALKIE_TALKIE_FIREBASE: {
                apiKey: "AIzaSyCBKQmhnE3E3TmF7UcyuM7NwQyM0FYzL-A",
                authDomain: "breakwatertimemgt.firebaseapp.com",
                databaseURL: "https://breakwatertimemgt-default-rtdb.firebaseio.com/",
                projectId: "breakwatertimemgt",
                storageBucket: "breakwatertimemgt.appspot.com",
                messagingSenderId: "806149652458",
                appId: "1:806149652458:web:d97884f60d2ff4644b7c93"
            }
        };

        // Initialize Firebase
        const firebaseApp = firebase.initializeApp(CONFIG.FIREBASE);
        const walkieTalkieFirebaseApp = firebase.initializeApp(CONFIG.WALKIE_TALKIE_FIREBASE, "walkieTalkie");

        // Global Variables
        let selectedStaff = null, currentData = {}, activeBreaks = {}, selectedArea = 'Area 2',
            selectedStore = null, staffList = [], unlockedAreas = ['Area 2'], 
            loggedInUser = 'user_' + Math.random().toString(36).substr(2, 9), activeDropdown = null,
            mediaRecorder = null, audioChunks = [], audioStream = null, audioContext = null,
            activeListeners = 0, activeTransmission = null, scannerInterval = null;

        // Area and Staff Data
        const areas = {
            "Area 1": {
                "Al Ghurair Centre": ["Melani", "Jayson", "Helen", "Arlene", "Al", "Dipesh"],
                "Burjuman": ["Sanjay", "Muhammed", "Shadab", "Manuel", "Sanjeev", "Janeth", "Naneth", "Evangeline", "Tin", "Muhamed", "Roselyn", "Liezel", "Robin", "Faizan"],
                "Deira City Centre": ["Sanjay", "Surya", "Mudassar", "Kyza", "Sunil", "Marcianco", "Marciel", "Joel", "Bishal", "Leofris", "Jasmine", "Yanden", "Juslyn", "Katrina", "Ezaz", "Maricar", "Anish", "Awad", "Sima", "Keshov", "Christina"],
                "Dubai Festival City": ["Ramesh", "Elvin", "Mohamed", "Manivannan", "Jay", "Leonito", "Jackielyn", "Janieca"],
                "Dubai Hills": ["Cristine", "Unnikrishnan", "Allan", "Saddam", "Rajiv", "Camille", "Annmae", "Mir", "Lelin", "Darwen", "Jamilla", "Gyani", "Anurag", "Damandeep", "Krishna"],
                "Dubai Mall": ["Mohamed", "Rosalinda", "Mylene", "Babylyn", "Milan", "Anshul", "Bibek", "Leah", "Kewal", "Saroj", "Yoon", "Mahtab", "Ma.Medalya", "Sudhan", "Nomilyn", "Su", "Passang"],
                "Ibn Battuta": ["Sureshwar", "Margie", "Mary", "Blair", "Chera", "Amaya", "Bishal", "Dinesh", "Babul", "Sabina", "Muschirniel"],
                "Mall of Emirates": ["Mohammed", "Ubaid", "Tank", "Cherrie", "Jennifer", "Rachelle", "Mary", "Manisha", "Hari", "Swechchha", "Birson", "Shekher", "Prashanth", "Subrata", "passang", "Swastika", "Mina", "Gilbee", "ABERT", "Ajib", "Fatima", "Alisha", "Junnu", "Suraj", "Amit", "Pema", "Chandra", "Juphet", "Nikki", "Nerilyn"],
                "Mirdiff City Centre": ["Nasim", "Samuela", "Mary", "Sharwan", "Ruben", "Santosh", "ASGAR", "Rejin", "Tuhin", "Bikram", "Kean", "Ritika", "Zuned", "Claret", "Sultan", "Yeshi", "Zahoor", "Sanju", "Miecka", "Sumina", "Isuru"],
                "Oasis Centre Dubai": ["Nishant", "Asif", "Sunita", "Casiraj", "Diovelyn", "Shabbir", "Silpa", "Ashok", "Junard", "Mohammed"],
                "Shoemart Outlet Mall": ["Obed", "Chetan", "Francisco", "Rajendra", "Khagendra", "Mohammed", "Kishor", "Philip", "Chand", "Dipesh", "Tibendra", "Khurram", "Mohammad"]
            },
            "Area 2": {
                "Marina Mall": ["Shankar", "Joveheldo", "Mary", "Jessel", "Mohammed", "Victoria", "Girlie", "Rohit", "Rolly", "Swetshel"],
                "Al-Ain Mall": ["Virendra", "Janice", "Dambar", "Marshal", "Rubina", "Rogelio", "Chris", "Mohamed", "Bishnu", "Leena"],
                "City Mall": ["Catherine", "Mary", "Mohamed", "Shiela", "Mhar", "Ram", "Ankit"],
                "Bawabat Store": ["Jeena", "Gelynbee", "Mar-Jay", "Miraj", "John", "Anisha", "Jacqueline", "Mohammed", "Angelica"],
                "Bawadi Mall": ["Sunny", "Pushpa", "Augustin", "Mohamed", "Ashmita", "Kezang", "Aashik", "Mahra", "KASHISH", "Karim", "Jemmalyn", "Khila", "Ravi", "Marlou"],
                "Dalma Mall": ["Zahid", "Ellen", "Drianne", "Asmaa", "Vipan", "Mohammed", "Armila", "Jesica", "Marian", "Maria", "Durga", "Jayvin"],
                "Deerfields Mall": ["John", "Allen", "Ramiz", "Siphora"],
                "Jimmi Mall": ["Eloysa", "Mohamed", "Mohamed", "April", "SALVADOR", "Mahmoud", "Sanu", "Maitha", "Waneya", "Sanjaya", "Sajani"],
                "World Trade Centre": ["Jerricho", "Gerlie", "Jacob", "Udawelagedara", "Nerissa"],
                "Yas Mall": ["Ireen", "Juvy", "Sandar", "Jemerie", "Abdul", "Ernielyn", "James", "Ricleen", "Sarah", "Neelam"],
                "Reem Mall": ["John", "Grece", "Nympha", "Kavindhya", "Akire"],
                "Al Maryah Central": ["Rachel", "Riza", "Mahammad", "Diosee", "Rojana", "Austria", "Rojan", "Justin"],
                "Al Ruwais Mall": ["Thaman", "Upasna", "Rabi", "Vina", "Mahesh"],
                "Alwahda Mall": ["Jay-D", "Jamyang", "Bibek", "John", "Naresh", "Charol"]
            },
            "Area 3": {
                "Al Zahia Centre": ["Roshan", "Ameet", "Monica", "Bishal", "Priyanka", "Melvin", "Angelica", "Michille", "Rubi", "Meera", "Mohammed", "Aamosh"],
                "Sahara Centre": ["Flordelis", "Ujjwal", "Ira", "Rhelmart", "Analyn", "Yudha", "Sandip"],
                "Ajman City Centre": ["Rajesh", "Balaram", "Nagie", "Lorie", "Yogendra", "Mohamed", "Shradha", "Shreejan", "Vishnu", "Prakash", "Saif", "Elizabeth", "Mohamed"],
                "Ajman Corniche": ["Pawan", "Shanell", "Bishal", "Ruth", "Swastika", "Lea"],
                "Fujairah": ["Shiela", "Ekramul", "Oscar", "Karan", "Crisalie", "Said", "Padma", "Adhari", "Benjar"],
                "Fujeira City Centre": ["Pratik", "Don", "Virginia", "Monica", "Nischal", "Sudha", "Shoshin", "Habeisha", "Leah"],
                "Oasis Centre Sharjah": ["Rajib", "Marvina", "Ravi", "Jevian", "Sanjay", "Warnakulasuriya"],
                "RAK Bin Dhahar": ["Bijendra", "Arif", "Jacqueline", "Mohammed", "Mary", "Mohammad", "Donalyn", "Maryam", "Angel", "NWE", "Shahd"],
                "Ras Al Khaima": ["Datsun", "Laxmi", "Jonalyne", "Harshdeep", "Sanjita", "Shahan", "Heba", "Divina", "Wafa", "Abdullah"],
                "Sharjah CC": ["Suraj", "Samiran", "Ezra", "Abu", "Chris", "Elvie", "Sarnim", "Mohammed", "Maham", "Mohamad", "Anil", "Nur", "Rodel", "Nirmal"]
            }
        };

        // Core Functions
        document.addEventListener('DOMContentLoaded', () => {
            initDate();
            updateStoreDropdown();
            loadStoreData();
            initMonthSelector();
            updateBanner();
            setInterval(checkForStatsReset, 60000);
            document.addEventListener('click', closeShiftDropdown);
            setupAudioListeners();
        });

        function initDate() { 
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); 
        }

        function updateStoreDropdown() {
            selectedArea = document.getElementById('area-select').value;
            const storeSelect = document.getElementById('store-select');
            storeSelect.innerHTML = '<option value="">Select Store</option>' + Object.keys(areas[selectedArea]).map(store => `<option value="${store}">${store}</option>`).join('');
            if (selectedStore) storeSelect.value = selectedStore;
            loadStoreData();
        }

        function loadStoreData() {
            selectedStore = document.getElementById('store-select').value;
            if (!selectedStore) {
                document.getElementById('staff-list').innerHTML = '<p>Please select a store</p>';
                document.getElementById('staff-count').textContent = "(Total: 0)";
                document.getElementById('store-title').textContent = "Floor Control";
                return;
            }
            
            staffList = areas[selectedArea][selectedStore] || [];
            document.getElementById('store-title').textContent = `${selectedStore} - Floor Control`;
            document.getElementById('staff-count').textContent = `(Total: ${staffList.length})`;
            renderStaff();
            firebase.database().ref(`stores/${selectedArea}/${selectedStore}`).on('value', snapshot => {
                const data = snapshot.val() || {};
                currentData = data.data || {};
                activeBreaks = data.breaks || {};
                updateStaffAndStats();
                updateAnalysis();
                renderRosterTable();
            });
            firebase.database().ref('users').child(loggedInUser).update({ area: selectedArea, store: selectedStore });
        }

        function renderStaff() {
            if (!staffList.length) {
                document.getElementById('staff-list').innerHTML = '<p>No staff available</p>';
                return;
            }
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('staff-list').innerHTML = staffList.map(staff => {
                const data = currentData[today]?.[staff] || {};
                const shift = currentData['shifts']?.[today]?.[staff];
                let statusClass = '';
                let countdown = '';
                if (activeBreaks[staff]?.active) {
                    const diff = new Date(activeBreaks[staff].endTime) - new Date();
                    if (diff > 0) {
                        const mins = Math.floor(diff / 60000);
                        const secs = Math.floor((diff % 60000) / 1000);
                        countdown = `<span class="countdown-timer">${mins}m ${secs}s</span>`;
                        statusClass = 'on-break';
                    }
                } else if (data.login && !data.logout) {
                    statusClass = 'on-floor';
                } else if (data.logout) {
                    statusClass = 'logged-out';
                } else if (shift === 'DAY OFF' || shift === 'LEAVE') {
                    statusClass = 'day-off-leave';
                }
                return `<div class="staff-badge ${selectedStaff === staff ? 'selected' : ''} ${statusClass}" onclick="selectStaff('${staff}')">${staff}${countdown}</div>`;
            }).join('');
        }

        function selectStaff(staff) { 
            selectedStaff = staff; 
            renderStaff(); 
        }

        function handleLogin() {
            if (!selectedStaff) return showMessage('Select a staff member', 'error');
            const today = new Date().toISOString().split('T')[0];
            currentData[today] = currentData[today] || {};
            currentData[today][selectedStaff] = currentData[today][selectedStaff] || {};
            currentData[today][selectedStaff].login = new Date().toISOString();
            updateStaffAndStats();
            updateAnalysis();
            showMessage(`${selectedStaff} logged in`, 'success');
            saveData();
        }

        function handleLogout() {
            if (!selectedStaff) return showMessage('Select a staff member', 'error');
            if (!currentData[new Date().toISOString().split('T')[0]]?.[selectedStaff]?.login) return showMessage('Select a logged-in staff', 'error');
            const today = new Date().toISOString().split('T')[0];
            currentData[today][selectedStaff].logout = new Date().toISOString();
            delete activeBreaks[selectedStaff];
            updateStaffAndStats();
            updateAnalysis();
            showMessage(`${selectedStaff} logged out`, 'success');
            saveData();
        }

        function handleBreak(action) {
            if (!selectedStaff) return showMessage('Select a staff member', 'error');
            const today = new Date().toISOString().split('T')[0];
            currentData[today] = currentData[today] || {};
            currentData[today][selectedStaff] = currentData[today][selectedStaff] || {};
            currentData[today][selectedStaff].breaks = currentData[today][selectedStaff].breaks || [];
            if (action === 'start') {
                if (activeBreaks[selectedStaff]?.active) return showMessage(`${selectedStaff} is on break`, 'error');
                const startTime = new Date().toISOString();
                currentData[today][selectedStaff].breaks.push({ start: startTime, end: null });
                activeBreaks[selectedStaff] = { active: true, start: startTime, endTime: new Date(Date.now() + 3600000).toISOString() };
                updateStaffAndStats();
                updateAnalysis();
                showMessage(`${selectedStaff} started break`, 'success');
                saveData();
            } else {
                if (!activeBreaks[selectedStaff]?.active) return showMessage(`${selectedStaff} is not on break`, 'error');
                const lastBreak = currentData[today][selectedStaff].breaks.find(b => b.start === activeBreaks[selectedStaff].start && !b.end);
                lastBreak.end = new Date().toISOString();
                delete activeBreaks[selectedStaff];
                updateStaffAndStats();
                updateAnalysis();
                showMessage(`${selectedStaff} ended break`, 'success');
                saveData();
            }
        }

        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const entries = currentData[today] || {};
            let morningCount = 0, afternoonCount = 0, breakCount = 0, floorCount = 0, loggedOutCount = 0, dayOffCount = 0;
            
            staffList.forEach(staff => {
                const data = entries[staff] || {};
                const shift = currentData['shifts']?.[today]?.[staff];
                
                // Count day off/leave first
                if (shift === 'DAY OFF' || shift === 'LEAVE') {
                    dayOffCount++;
                    return; // Skip further checks for this staff
                }
                if (data.login) {
                    // Morning/Afternoon count
                    const loginHour = new Date(data.login).getHours();
                    loginHour < 12 ? morningCount++ : afternoonCount++;

                    // Status counts
                    if (data.logout) {
                        loggedOutCount++;
                    } else if (activeBreaks[staff]?.active) {
                        breakCount++;
                    } else {
                        floorCount++;
                    }
                } else {
                    // Count non-logged-in staff without shifts as logged out
                    loggedOutCount++;
                }
            });
            document.getElementById('morning-count').textContent = morningCount;
            document.getElementById('afternoon-count').textContent = afternoonCount;
            document.getElementById('break-count').textContent = breakCount;
            document.getElementById('floor-count').textContent = floorCount;
            document.getElementById('left-count').textContent = loggedOutCount;
            document.getElementById('day-off-count').textContent = dayOffCount;
            
            const allLoggedOut = staffList.every(staff => entries[staff]?.logout);
            if (allLoggedOut) {
                document.getElementById('bannerMessage').textContent = `Team ${selectedStore} has left for the day`;
                resetStats();
            } else {
                updateBanner();
            }
        }

        async function saveData() {
            if (selectedStore) {
                await firebase.database().ref(`stores/${selectedArea}/${selectedStore}`).set({
                    data: currentData,
                    breaks: activeBreaks,
                    unlockedAreas
                });
            }
        }

        function initMonthSelector() {
            const monthSelect = document.getElementById('month-select');
            const currentDate = new Date();
            monthSelect.innerHTML = Array.from({ length: 12 }, (_, i) => {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                return `<option value="${value}">${date.toLocaleString('default', { month: 'long', year: 'numeric' })}</option>`;
            }).join('');
            monthSelect.value = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            updateAnalysis();
        }

        function updateAnalysis() {
            const [year, month] = document.getElementById('month-select').value.split('-');
            const monthData = Object.keys(currentData).filter(date => date.startsWith(`${year}-${month}`)).map(date => {
                const rows = staffList.map(staff => {
                    const data = currentData[date]?.[staff] || {};
                    const shift = currentData['shifts']?.[date]?.[staff];
                    const totalBreakMs = (data.breaks || []).reduce((sum, b) => b.start && b.end ? sum + (new Date(b.end) - new Date(b.start)) : sum, 0);
                    const totalWorkedMs = data.login && data.logout ? (new Date(data.logout) - new Date(data.login)) : 0;
                    const lastBreak = data.breaks?.length ? data.breaks[data.breaks.length - 1] : null;
                    return {
                        staff,
                        plannedShift: shift || '-',
                        loginTime: (shift === 'DAY OFF' || shift === 'LEAVE') ? '-' : (data.login ? formatTime(new Date(data.login)) : '-'),
                        startBreak: lastBreak?.start ? formatTime(new Date(lastBreak.start)) : '-',
                        endBreak: lastBreak?.end ? formatTime(new Date(lastBreak.end)) : '-',
                        logoutTime: data.logout ? formatTime(new Date(data.logout)) : '-',
                        totalWorkedHours: totalWorkedMs > 0 ? (totalWorkedMs / 3600000).toFixed(2) + 'h' : '-',
                        totalBreakHours: totalBreakMs > 0 ? (totalBreakMs / 60000).toFixed(0) + 'm' : '-'
                    };
                }).filter(row => row.loginTime !== '-' || row.plannedShift !== '-');
                return rows.length ? { date, rows } : null;
            }).filter(Boolean).sort((a, b) => b.date.localeCompare(a.date));
            const dateSelect = document.getElementById('date-select');
            dateSelect.innerHTML = '<option value="">All Dates</option>' + monthData.map(day => `<option value="${day.date}">${day.date}</option>`).join('');
            renderAnalysis(monthData);
        }

        function renderAnalysis(data) {
            document.getElementById('analysis-container').innerHTML = data.map(day => `
                <div class="day-panel">
                    <h3>${day.date}</h3>
                    <div class="analysis-table-wrapper">
                        <table class="analysis-table">
                            <thead>
                                <tr>
                                    <th>Staff</th>
                                    <th>Shift</th>
                                    <th>Login</th>
                                    <th>Start Break</th>
                                    <th>End Break</th>
                                    <th>Logout</th>
                                    <th>Total Hours</th>
                                    <th>Break Hours</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${day.rows.map(row => `
                                    <tr>
                                        <td>${row.staff}</td>
                                        <td>${row.plannedShift}</td>
                                        <td>${row.loginTime}</td>
                                        <td>${row.startBreak}</td>
                                        <td>${row.endBreak}</td>
                                        <td>${row.logoutTime}</td>
                                        <td>${row.totalWorkedHours}</td>
                                        <td>${row.totalBreakHours}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        }

        function filterByDate() {
            const selectedDate = document.getElementById('date-select').value;
            updateAnalysis();
            if (selectedDate) {
                const filtered = Array.from(document.querySelectorAll('.day-panel')).filter(panel => panel.querySelector('h3').textContent === selectedDate).map(panel => panel.outerHTML).join('');
                document.getElementById('analysis-container').innerHTML = filtered || '<p>No data for this date</p>';
            }
        }

        function formatTime(date) { 
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }); 
        }

        function showMessage(text, type = 'success') {
            const msg = document.getElementById('message-container');
            msg.textContent = text;
            msg.className = `message ${type} active`;
            setTimeout(() => msg.classList.remove('active'), 4000);
        }

        function updateStaffAndStats() { 
            renderStaff(); 
            updateStats(); 
        }

        function showStatDetails(title) {
            const today = new Date().toISOString().split('T')[0];
            const entries = currentData[today] || {};
            let items = [];
            switch (title) {
                case 'Morning Login': items = staffList.filter(s => entries[s]?.login && new Date(entries[s].login).getHours() < 12); break;
                case 'Afternoon Login': items = staffList.filter(s => entries[s]?.login && new Date(entries[s].login).getHours() >= 12); break;
                case 'On Break': items = staffList.filter(s => activeBreaks[s]?.active); break;
                case 'On Floor': items = staffList.filter(s => entries[s]?.login && !entries[s]?.logout && !activeBreaks[s]?.active); break;
                case 'Logged Out': items = staffList.filter(s => entries[s]?.logout); break;
                case 'Day Off': items = staffList.filter(s => currentData['shifts']?.[today]?.[s] === 'DAY OFF' || currentData['shifts']?.[today]?.[s] === 'LEAVE'); break;
            }
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalList').innerHTML = items.length ? items.map((item, index) => `<div style="--i: ${index}">${item}</div>`).join('') : '<div>No staff</div>';
            document.getElementById('detailModal').style.display = 'flex';
        }

        function closeModal() { 
            document.getElementById('detailModal').style.display = 'none'; 
        }

        function showLockModal() { 
            document.getElementById('lockModal').style.display = 'flex'; 
        }

        function closeLockModal() { 
            document.getElementById('lockModal').style.display = 'none'; 
        }

        async function unlockAreas() {
            const area = document.getElementById('unlock-username').value;
            const password = document.getElementById('unlock-password').value;
            if (Object.keys(areas).includes(area) && password === '1111' && !unlockedAreas.includes(area)) {
                unlockedAreas.push(area);
                document.getElementById('area-select').innerHTML = unlockedAreas.map(a => `<option value="${a}" ${a === selectedArea ? 'selected' : ''}>${a}</option>`).join('');
                await saveData();
                showMessage(`${area} unlocked`, 'success');
                closeLockModal();
            } else {
                showMessage('Invalid credentials or area already unlocked', 'error');
            }
        }

        function showRosterModal() { 
            if (!selectedStore) return showMessage('Please select a store first', 'error');
            document.getElementById('rosterModal').style.display = 'flex'; 
            renderRosterTable(); 
        }

        function closeRosterModal() { 
            document.getElementById('rosterModal').style.display = 'none'; 
        }

        function renderRosterTable() {
            const today = new Date();
            const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 1));
            const dates = Array.from({ length: 7 }, (_, i) => {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                return date.toISOString().split('T')[0];
            });
            const header = document.getElementById('roster-table-header');
            header.innerHTML = `<tr><th>Staff</th>${dates.map(date => `<th>${new Date(date).toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' })}</th>`).join('')}</tr>`;
            const body = document.getElementById('roster-table-body');
            body.innerHTML = staffList.map(staff => `
                <tr>
                    <td>${staff}</td>
                    ${dates.map(date => `
                        <td class="shift-cell ${currentData['shifts']?.[date]?.[staff] ? 'shift-' + currentData['shifts']?.[date]?.[staff] : ''}" 
                            onclick="showShiftDropdown(event, '${staff}', '${date}')">
                            ${currentData['shifts']?.[date]?.[staff] || '-'}
                        </td>
                    `).join('')}
                </tr>
            `).join('');
        }

        function showShiftDropdown(event, staff, date) {
            event.stopPropagation();
            if (!selectedStore) {
                showMessage('Please select a store first', 'error');
                return;
            }
            if (activeDropdown) {
                activeDropdown.remove();
                activeDropdown = null;
            }
            const shiftOptions = ['AM', 'PM', 'MID', 'DAY OFF', 'LEAVE', 'SICK', 'STK'];
            const cell = event.target;
            const dropdown = document.createElement('div');
            dropdown.className = 'shift-dropdown';
            dropdown.innerHTML = shiftOptions.map(option => `
                <div class="shift-option" onclick="selectShift('${staff}', '${date}', '${option}', this.parentElement.parentElement.querySelector('.shift-cell.active'))">${option}</div>
            `).join('');
            const rect = cell.getBoundingClientRect();
            const tableContainer = document.querySelector('.roster-table-container');
            const containerRect = tableContainer.getBoundingClientRect();
            dropdown.style.top = `${rect.bottom - containerRect.top + tableContainer.scrollTop}px`;
            dropdown.style.left = `${rect.left - containerRect.left + tableContainer.scrollLeft}px`;
            tableContainer.appendChild(dropdown);
            activeDropdown = dropdown;
            cell.classList.add('active');
            setTimeout(() => dropdown.classList.add('show'), 10);
        }

        async function selectShift(staff, date, shift, cell) {
            currentData['shifts'] = currentData['shifts'] || {};
            currentData['shifts'][date] = currentData['shifts'][date] || {};
            currentData['shifts'][date][staff] = shift;
            if (cell) {
                cell.textContent = shift;
                cell.classList.remove('active');
            }
            updateStaffAndStats();
            updateAnalysis();
            showMessage(`Shift updated for ${staff} on ${date} to ${shift}`, 'success');
            await saveData();
            if (activeDropdown) {
                activeDropdown.remove();
                activeDropdown = null;
            }
        }

        function closeShiftDropdown(event) {
            if (activeDropdown && !activeDropdown.contains(event.target)) {
                const activeCell = document.querySelector('.shift-cell.active');
                if (activeCell) activeCell.classList.remove('active');
                activeDropdown.remove();
                activeDropdown = null;
            }
        }

        // Barcode Scanner Functions
        async function startScanner(targetField) {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                showMessage('Barcode scanning requires HTTPS or localhost', 'error');
                return;
            }
            
            const modal = document.getElementById('scannerModal');
            const video = document.getElementById('scannerVideo');
            const canvas = document.getElementById('scannerCanvas');
            const ctx = canvas.getContext('2d');
            
            modal.style.display = 'block';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
                await video.play();
                
                // Set canvas dimensions to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Start scanning for barcodes
                scannerInterval = setInterval(() => {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = scanForBarcode(imageData);
                    
                    if (code) {
                        document.getElementById(targetField).value = code;
                        if (targetField === 'bin-search') searchBinHash();
                        if (targetField === 'odd-search') searchOddPair();
                        stopScanner();
                    }
                }, 500);
                
            } catch (err) {
                console.error('Camera error:', err);
                showMessage(`Camera error: ${err.message}`, 'error');
                stopScanner();
            }
        }

        function scanForBarcode(imageData) {
            // This is a very simple barcode scanner that looks for a pattern of black and white bars
            // For production, you should use a proper barcode scanning library
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            
            // Scan the middle row of the image
            const middleRow = Math.floor(height / 2);
            let pixels = [];
            
            // Convert to grayscale and threshold
            for (let x = 0; x < width; x++) {
                const i = (middleRow * width + x) * 4;
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const gray = (r + g + b) / 3;
                pixels.push(gray < 128 ? 1 : 0); // 1 for black, 0 for white
            }
            
            // Look for patterns that might be a barcode
            let currentVal = pixels[0];
            let count = 1;
            let bars = [];
            
            for (let i = 1; i < pixels.length; i++) {
                if (pixels[i] === currentVal) {
                    count++;
                } else {
                    bars.push({ val: currentVal, count });
                    currentVal = pixels[i];
                    count = 1;
                }
            }
            bars.push({ val: currentVal, count });
            
            // Simple check for barcode pattern (alternating black and white bars)
            if (bars.length > 10) {
                // Try to decode as a simple numeric barcode
                let code = '';
                for (let i = 0; i < bars.length; i += 2) {
                    if (bars[i].val === 1 && bars[i].count > 5) {
                        code += '1';
                    } else if (bars[i].val === 0 && bars[i].count > 5) {
                        code += '0';
                    }
                }
                
                if (code.length > 5) {
                    return code;
                }
            }
            
            return null;
        }

        function stopScanner() {
            if (scannerInterval) {
                clearInterval(scannerInterval);
                scannerInterval = null;
            }
            const modal = document.getElementById('scannerModal');
            const video = document.getElementById('scannerVideo');
            modal.style.display = 'none';
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        // Banner and Reset Functions
        function updateBanner() {
            const today = new Date().toISOString().split('T')[0];
            const allLoggedOut = staffList.every(staff => currentData[today]?.[staff]?.logout);
            
            if (allLoggedOut) {
                document.getElementById('bannerMessage').textContent = `Team ${selectedStore} has left for the day`;
            } else {
                document.getElementById('bannerMessage').textContent = 
                    `Team ${selectedStore || 'Loading...'}, Let's Rock Today! Keep the energy high and targets higher!`;
            }
        }

        function checkForStatsReset() {
            const today = new Date().toISOString().split('T')[0];
            const allLoggedOut = staffList.every(staff => currentData[today]?.[staff]?.logout);
            if (allLoggedOut) resetStats();
        }

        function resetStats() {
            ['morning-count', 'afternoon-count', 'break-count', 'floor-count', 'left-count', 'day-off-count']
                .forEach(id => document.getElementById(id).textContent = '0');
            showMessage('Stats reset for the day', 'success');
        }

        // Walkie-Talkie Audio Functions
        async function setupAudioListeners() {
            if (!selectedStore) return;
            
            // Count active listeners
            walkieTalkieFirebaseApp.database().ref(`stores/${selectedArea}/${selectedStore}/audio/listeners`)
                .on('value', snapshot => {
                    const count = snapshot.numChildren();
                    document.getElementById('active-count').textContent = count;
                });
            
            // Listen for new audio messages
            walkieTalkieFirebaseApp.database().ref(`stores/${selectedArea}/${selectedStore}/audio/messages`)
                .orderByChild('timestamp')
                .limitToLast(1)
                .on('child_added', snapshot => {
                    const audioData = snapshot.val();
                    if (audioData.sender !== loggedInUser) {
                        playAudio(audioData.data);
                    }
                });
        }

        async function startWalkieTalkie() {
            if (!selectedStore) return showMessage('Select a store', 'error');
            
            try {
                // Register as active listener
                const listenerRef = walkieTalkieFirebaseApp.database()
                    .ref(`stores/${selectedArea}/${selectedStore}/audio/listeners`)
                    .child(loggedInUser);
                
                await listenerRef.set(true);
                listenerRef.onDisconnect().remove();
                
                // Initialize audio context if not already done
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Get microphone access
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(audioStream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const arrayBuffer = await audioBlob.arrayBuffer();
                    const base64String = arrayBufferToBase64(arrayBuffer);
                    
                    await walkieTalkieFirebaseApp.database()
                        .ref(`stores/${selectedArea}/${selectedStore}/audio/messages`)
                        .push({
                            data: base64String,
                            timestamp: Date.now(),
                            sender: loggedInUser
                        });
                    
                    audioChunks = [];
                };
                
                mediaRecorder.start(250); // Collect data every 250ms
                document.getElementById('walkie-talkie-btn').classList.add('active');
                
            } catch (err) {
                console.error('Audio error:', err);
                showMessage('Microphone access denied', 'error');
                stopWalkieTalkie();
            }
        }

        function stopWalkieTalkie() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            
            // Remove listener registration
            walkieTalkieFirebaseApp.database()
                .ref(`stores/${selectedArea}/${selectedStore}/audio/listeners`)
                .child(loggedInUser)
                .remove();
            
            document.getElementById('walkie-talkie-btn').classList.remove('active');
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function playAudio(base64Data) {
            try {
                const binaryString = window.atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(blob);
                const audio = new Audio(audioUrl);
                audio.play().catch(err => console.error('Playback error:', err));
            } catch (err) {
                console.error('Audio playback error:', err);
            }
        }

        async function searchBinHash() {
            const itemId = document.getElementById('bin-search').value.trim();
            if (!itemId) return showMessage('Enter an Item ID', 'error');
            
            const resultsBody = document.getElementById('bin-result');
            resultsBody.innerHTML = `<tr><td colspan="4" style="text-align:center"><div class="spinner"></div> Searching...</td></tr>`;
            
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.GOOGLE_SHEETS.SHEET_ID}/values/${CONFIG.GOOGLE_SHEETS.RANGE}?key=${CONFIG.GOOGLE_SHEETS.API_KEY}`
                );
                const data = await response.json();
                const results = data.values.slice(1).filter(row => row[0] === itemId);

                resultsBody.innerHTML = results.length > 0 
                    ? results.map(row => `
                        <tr>
                            <td>${row[0]}</td>
                            <td>${row[1]}</td>
                            <td>${row[2]}</td>
                            <td>${row[3]}</td>
                        </tr>`
                    ).join('')
                    : '<tr><td colspan="4">No results found</td></tr>';
                showMessage('Bin Hash search completed', 'success');
            } catch (err) {
                console.error('Search error:', err);
                resultsBody.innerHTML = '<tr><td colspan="4">Error loading data</td></tr>';
                showMessage('Error fetching data', 'error');
            }
        }

        async function searchOddPair() {
            const itemId = document.getElementById('odd-search').value.trim();
            if (!itemId) return showMessage('Enter an Item ID', 'error');
            
            const resultsBody = document.getElementById('odd-result');
            resultsBody.innerHTML = `<tr><td colspan="4" style="text-align:center"><div class="spinner"></div> Searching...</td></tr>`;
            
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.GOOGLE_SHEETS.SHEET_ID}/values/Sheet2!A:F?key=${CONFIG.GOOGLE_SHEETS.API_KEY}`
                );
                const data = await response.json();
                const results = data.values.slice(1).filter(row => row[0] === itemId);

                resultsBody.innerHTML = results.length > 0 
                    ? results.map(row => `
                        <tr>
                            <td>${row[0]}</td>
                            <td>${row[4]}</td>
                            <td>${row[5]}</td>
                            <td>${row[1]}</td>
                        </tr>`
                    ).join('')
                    : '<tr><td colspan="4">No results found</td></tr>';
                showMessage('Odd Pair search completed', 'success');
            } catch (err) {
                console.error('Search error:', err);
                resultsBody.innerHTML = '<tr><td colspan="4">Error loading data</td></tr>';
                showMessage('Error fetching data', 'error');
            }
        }

        async function playRecentBroadcast() {
            try {
                const snapshot = await walkieTalkieFirebaseApp.database()
                    .ref(`stores/${selectedArea}/${selectedStore}/audio/messages`)
                    .orderByChild('timestamp')
                    .limitToLast(1)
                    .once('value');
                
                snapshot.forEach(childSnapshot => {
                    const audioData = childSnapshot.val();
                    if (audioData.sender !== loggedInUser) {
                        playAudio(audioData.data);
                    }
                });
            } catch (err) {
                console.error('Error fetching recent broadcast:', err);
                showMessage('No recent broadcasts available', 'error');
            }
        }

        function refreshData() { 
            loadStoreData(); 
            updateStaffAndStats(); 
            updateAnalysis(); 
            showMessage('Data refreshed', 'info'); 
        }

        setInterval(() => { 
            if (Object.keys(activeBreaks).length) { 
                renderStaff(); 
            } 
        }, 1000);
    </script>
</body>
</html>
