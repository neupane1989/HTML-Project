<!DOCTYPE html><html>
<head>
  <title>Push-to-Talk Voice Chat</title>
  <style>
    body { font-family: Arial; text-align: center; background: #f0f2f5; }
    select, button { margin: 10px; padding: 10px; font-size: 16px; }
    #pushToTalkBtn {
      background-color: #007bff;
      color: white;
      padding: 15px 30px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    #pushToTalkBtn:active {
      background-color: red;
    }
  </style>
</head>
<body>
  <h2>Store Voice Chat (Push-to-Talk)</h2>
  <select id="storeSelect">
    <option disabled selected>Select Store</option>
  </select>
  <div id="employeeList"></div>
  <br>
  <button id="joinStoreBtn">Join Store</button>
  <br>
  <button id="pushToTalkBtn" disabled>Hold to Talk</button>  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAJQu2PRjPTBGE8-S39oul5HHAgWhUNhxM",
      authDomain: "trial-walkie-talkie.firebaseapp.com",
      databaseURL: "https://trial-walkie-talkie-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "trial-walkie-talkie",
      storageBucket: "trial-walkie-talkie.firebasestorage.app",
      messagingSenderId: "95655331213",
      appId: "1:95655331213:web:36b14ce3285ddeec7c69c4",
      measurementId: "G-YN1F55TJVN"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const stores = {
      "Store A": ["Alice", "Bob", "Charlie"],
      "Store B": ["David", "Eve", "Frank"],
      "Store C": ["Grace", "Heidi", "Ivan"]
    };

    const storeSelect = document.getElementById("storeSelect");
    const employeeList = document.getElementById("employeeList");
    const talkButton = document.getElementById("pushToTalkBtn");
    const joinStoreBtn = document.getElementById("joinStoreBtn");

    let localStream;
    let peers = {};
    let connections = {};
    let currentStore = null;
    const userId = Math.random().toString(36).substring(2);

    for (let store in stores) {
      let option = document.createElement("option");
      option.value = store;
      option.innerText = store;
      storeSelect.appendChild(option);
    }

    joinStoreBtn.addEventListener("click", async () => {
      if (!storeSelect.value) return alert("Please select a store first");
      currentStore = storeSelect.value;
      employeeList.innerHTML = `<strong>Employees:</strong> ${stores[currentStore].join(", ")}`;
      talkButton.disabled = false;
      joinRoom(currentStore);
    });

    async function joinRoom(room) {
      const roomRef = db.ref(`rooms/${room}`);
      const userRef = roomRef.child(userId);

      // Send offer to new users
      roomRef.on("child_added", async (snapshot) => {
        const remoteId = snapshot.key;
        if (remoteId === userId || connections[remoteId]) return;

        const pc = createPeerConnection(remoteId);
        connections[remoteId] = pc;

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        db.ref(`rooms/${room}/${userId}/offers/${remoteId}`).set(pc.localDescription.toJSON());
      });

      // Handle offer from another user
      userRef.child("offers").on("child_added", async (snapshot) => {
        const remoteId = snapshot.key;
        if (connections[remoteId]) return;

        const pc = createPeerConnection(remoteId);
        connections[remoteId] = pc;

        const offer = snapshot.val();
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        db.ref(`rooms/${room}/${remoteId}/answers/${userId}`).set(pc.localDescription.toJSON());
      });

      // Handle answer
      userRef.child("answers").on("child_added", async (snapshot) => {
        const remoteId = snapshot.key;
        const answer = snapshot.val();
        const pc = connections[remoteId];
        if (pc && answer) {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        }
      });
    }

    function createPeerConnection(remoteId) {
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      pc.ontrack = (event) => {
        const audio = document.createElement("audio");
        audio.srcObject = event.streams[0];
        audio.autoplay = true;
        audio.playsInline = true;
        audio.setAttribute("autoplay", true);
        audio.setAttribute("playsinline", true);
        document.body.appendChild(audio);
        audio.play().catch(e => console.log("Autoplay error:", e));
      };

      return pc;
    }

    talkButton.addEventListener("touchstart", startTalking);
    talkButton.addEventListener("mousedown", startTalking);
    talkButton.addEventListener("touchend", stopTalking);
    talkButton.addEventListener("mouseup", stopTalking);

    async function startTalking() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        Object.values(connections).forEach(pc => {
          localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        });
      } catch (err) {
        alert("Microphone access denied or not available.");
      }
    }

    function stopTalking() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
    }
  </script></body>
</html>

