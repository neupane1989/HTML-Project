<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI TRACKER</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Same styles as UAE performance page */
    </style>
</head>
<body>
    <h2 style="color: #2c3e50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
        KPI TRACKER
    </h2>

    <div class="input-group">
        <label for="area">Area:</label>
        <select id="area" onchange="updateAreaStores()">
            <option value="All">All Areas</option>
        </select>
    </div>

    <div class="input-group">
        <label for="store">Store Name:</label>
        <select id="store" onchange="updateTable()">
            <option value="All">All Stores</option>
        </select>
    </div>

    <table id="kpiTable">
        <thead>
            <tr>
                <th>AREA</th>
                <th>STORE</th>
                <th>KPI METRIC</th>
                <th>TARGET</th>
                <th>ACTUAL</th>
                <th>VARIANCE</th>
                <th>ACHIEVEMENT %</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const GOOGLE_SHEETS_URL = "https://docs.google.com/spreadsheets/d/1aV9fmN_xkzaKTn-tKCXLS9-Vss_9Os9zkEtrVmoWFvE/export?format=csv";
        let allData = [];
        let areaStoreMap = {};

        async function loadData() {
            try {
                const response = await fetch(GOOGLE_SHEETS_URL);
                const csvData = await response.text();
                const workbook = XLSX.read(csvData, { type: 'string' });
                const sheet = workbook.Sheets[workbook.SheetNames[2]]; // Use third sheet
                allData = XLSX.utils.sheet_to_json(sheet);
                processData();
                initializeAreas();
                updateTable();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function processData() {
            areaStoreMap = {};
            allData.forEach(row => {
                const area = row.Area;
                const store = row.Store;
                if (!areaStoreMap[area]) areaStoreMap[area] = new Set();
                areaStoreMap[area].add(store);
            });
        }

        function initializeAreas() {
            const areaSelect = document.getElementById('area');
            Object.keys(areaStoreMap).forEach(area => {
                areaSelect.innerHTML += `<option value="${area}">${area}</option>`;
            });
        }

        function updateAreaStores() {
            const area = document.getElementById('area').value;
            const storeSelect = document.getElementById('store');
            storeSelect.innerHTML = '<option value="All">All Stores</option>';
            
            if (area !== 'All') {
                Array.from(areaStoreMap[area]).forEach(store => {
                    storeSelect.innerHTML += `<option value="${store}">${store}</option>`;
                });
            }
            updateTable();
        }

        function updateTable() {
            const area = document.getElementById('area').value;
            const store = document.getElementById('store').value;
            
            const filteredData = allData.filter(row => {
                return (area === 'All' || row.Area === area) && 
                       (store === 'All' || row.Store === store);
            });

            const tbody = document.querySelector('#kpiTable tbody');
            tbody.innerHTML = filteredData.map(row => `
                <tr>
                    <td>${row.Area}</td>
                    <td>${row.Store}</td>
                    <td>${row['KPI Metric']}</td>
                    <td>${row.Target}</td>
                    <td>${row.Actual}</td>
                    <td>${row.Variance}</td>
                    <td>${row['Achievement %']}%</td>
                </tr>
            `).join('');
        }

        window.onload = loadData;
    </script>
</body>
</html>
